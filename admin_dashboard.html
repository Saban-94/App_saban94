<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×—×“×¨ ×‘×§×¨×” - × ×™×”×•×œ CRM</title>
    <link rel="icon" href="https://img.icons8.com/?size=100&id=9fZ3EWahbXyH&format=png&color=000000">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- 1. CSS Variables (Design Tokens) --- */
        :root {
            --primary: #0b72b9; /* A professional blue */
            --primary-light: #e6f7ff;
            --primary-dark: #0056b3;
            --secondary: #6c757d;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --info: #17a2b8;
            --light: #f8f9fa;
            --bg-light: #f0f2f5;
            --card-bg: #ffffff;
            --text-color: #212529;
            --text-muted: #6c757d;
            --border-color: #dee2e6;
            --radius: 12px;
            --shadow: 0 6px 20px rgba(0, 0, 0, 0.07);
            --font-main: 'Assistant', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        /* --- 2. General & Layout Styling --- */
        * { box-sizing: border-box; }
        body {
            font-family: var(--font-main);
            background-color: var(--bg-light);
            margin: 0;
            padding: 25px;
            color: var(--text-color);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .container { max-width: 1600px; margin: 0 auto; }
        header { text-align: center; margin-bottom: 25px; }
        header h1 {
            color: var(--primary);
            display: inline-flex;
            align-items: center;
            gap: 12px;
            font-size: 2.2rem;
            margin: 0;
        }
        header p { color: var(--text-muted); font-size: 1.1rem; margin-top: 5px; }
        .dashboard { display: grid; grid-template-columns: 2.5fr 1fr; gap: 25px; align-items: flex-start; }

        /* --- 3. NEW Online Users Bar --- */
        .online-users-container {
            background-color: var(--card-bg);
            border-radius: var(--radius);
            padding: 20px 25px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            margin-bottom: 25px;
        }
        .online-users-container h2 { margin: 0 0 15px; font-size: 1.5rem; display: flex; align-items: center; gap: 10px; }
        .online-users-list {
            display: flex;
            gap: 20px;
            list-style: none;
            padding: 0;
            margin: 0;
            overflow-x: auto;
            padding-bottom: 15px; /* For scrollbar */
        }
        .online-user { text-align: center; flex-shrink: 0; }
        .avatar-container {
            position: relative;
            width: 64px;
            height: 64px;
            margin: 0 auto 8px;
            cursor: pointer;
        }
        .avatar { width: 100%; height: 100%; border-radius: 50%; border: 3px solid var(--border-color); object-fit: cover; }
        .avatar-container:hover .avatar { border-color: var(--primary); }
        .status-dot {
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            border: 2px solid white;
        }
        .status-dot.online { background-color: var(--success); }
        .status-dot.offline { background-color: var(--secondary); }
        .user-info .user-name { font-weight: 600; display: block; }
        .user-info .user-id { font-size: 0.85rem; color: var(--text-muted); }

        .user-tooltip {
            display: none;
            position: absolute;
            bottom: 110%;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.9rem;
            white-space: nowrap;
            z-index: 10;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .user-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #333 transparent transparent transparent;
        }
        .avatar-container:hover .user-tooltip { display: block; }
        .tooltip-status-indicator { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-inline-end: 5px; }

        /* --- 4. Component Styling (Existing & Enhanced) --- */
        .card { background-color: var(--card-bg); border-radius: var(--radius); padding: 25px; box-shadow: var(--shadow); border: 1px solid var(--border-color); }
        .card-header { border-bottom: 1px solid var(--border-color); padding-bottom: 15px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .card-header h2 { margin: 0; font-size: 1.5rem; display: flex; align-items: center; gap: 10px; }
        .table-responsive { overflow-x: auto; }
        .clients-table { width: 100%; border-collapse: collapse; text-align: right; font-size: 0.95rem; }
        .clients-table th, .clients-table td { padding: 14px 15px; border-bottom: 1px solid var(--border-color); vertical-align: middle; }
        .clients-table th { font-weight: 700; background-color: var(--light); color: var(--primary); }
        .clients-table tbody tr:hover { background-color: var(--primary-light); }
        
        .btn { border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 700; transition: all 0.2s ease-in-out; display: inline-flex; align-items: center; justify-content: center; gap: 8px; font-size: 0.9rem; font-family: var(--font-main); }
        .btn.primary { background-color: var(--primary); color: white; }
        .btn.primary:hover { background-color: var(--primary-dark); transform: translateY(-2px); box-shadow: 0 4px 10px rgba(13, 110, 253, 0.3); }

        .requests-log { list-style-type: none; padding: 0; margin: 0; max-height: 520px; overflow-y: auto; }
        .requests-log li { padding: 12px; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; gap: 15px; transition: background-color 0.2s; }
        .requests-log li:hover { background-color: var(--light); }
        .requests-log li:last-child { border-bottom: none; }
        .requests-log .icon { width: 40px; height: 40px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; color: white; flex-shrink: 0; }
        .requests-log .icon.×”×—×œ×¤×” { background-color: var(--warning); }
        .requests-log .icon.×”×¢×œ××”, .requests-log .icon.×”×•×¨×“×” { background-color: var(--info); }
        .requests-log .icon.×”×•×“×¢×ª { background-color: var(--secondary); }
        .requests-log .content strong { display: block; color: var(--text-color); }
        .requests-log .content .meta { font-size: 0.85rem; color: var(--text-muted); }

        .placeholder-row td, .placeholder-item { color: var(--text-muted); text-align: center; font-style: italic; padding: 30px !important; }

        /* --- 5. Modal Styling --- */
        .modal-overlay { position: fixed; inset: 0; background-color: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 1000; opacity: 0; transition: opacity 0.3s; }
        .modal-overlay.show { display: flex; opacity: 1; }
        .modal-content { background-color: white; padding: 30px; border-radius: var(--radius); width: 90%; max-width: 500px; position: relative; transform: scale(0.95); transition: transform 0.3s; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .modal-overlay.show .modal-content { transform: scale(1); }
        .modal-close { position: absolute; top: 15px; left: 20px; background: none; border: none; font-size: 1.8rem; cursor: pointer; color: var(--secondary); transition: transform 0.2s; }
        .modal-close:hover { transform: scale(1.1); }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--primary); }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; box-sizing: border-box; font-size: 1rem; font-family: var(--font-main); transition: box-shadow 0.2s, border-color 0.2s; }
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-light); }

        /* --- 6. Responsive Design --- */
        @media (max-width: 992px) {
            .dashboard { grid-template-columns: 1fr; }
            body { padding: 15px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="header-icon"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
                ×—×“×¨ ×‘×§×¨×” ×œ×× ×”×œ
            </h1>
            <p>×©×œ×™×—×ª ×”×ª×¨××•×ª ×•× ×™×”×•×œ ×‘×§×©×•×ª ×œ×§×•×—×•×ª</p>
        </header>

        <!-- NEW: Online Users Bar -->
        <section class="online-users-container">
            <h2>
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                ×œ×§×•×—×•×ª ××—×•×‘×¨×™×
            </h2>
            <ul id="online-users-list" class="online-users-list">
                 <li id="online-users-loader" class="placeholder-item" style="width: 100%;">×˜×•×¢×Ÿ ×¨×©×™××ª ×œ×§×•×—×•×ª...</li>
            </ul>
        </section>
        
        <main class="dashboard">
            <section class="card clients-card">
                <div class="card-header">
                    <h2>
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line><line x1="9" y1="21" x2="9" y2="9"></line></svg>
                        ×œ×§×•×—×•×ª ×¢× ××›×•×œ×•×ª ×‘×©×˜×—
                    </h2>
                </div>
                <div class="table-responsive">
                    <table class="clients-table">
                        <thead>
                            <tr>
                                <th>××¡' ×œ×§×•×—</th>
                                <th>×©× ×œ×§×•×—</th>
                                <th>×›×ª×•×‘×ª</th>
                                <th>×™××™× ×‘×©×˜×—</th>
                                <th>×¤×¢×•×œ×”</th>
                            </tr>
                        </thead>
                        <tbody id="clients-table-body">
                           <tr id="clients-loader"><td colspan="5" class="placeholder-row">×˜×•×¢×Ÿ ×œ×§×•×—×•×ª...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <section class="card requests-card">
                 <div class="card-header">
                    <h2>
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                        ×™×•××Ÿ ×‘×§×©×•×ª ××—×¨×•× ×•×ª
                    </h2>
                </div>
                <ul id="requests-log" class="requests-log">
                    <li id="requests-loader" class="placeholder-item">×˜×•×¢×Ÿ ×‘×§×©×•×ª...</li>
                </ul>
            </section>
        </main>
    </div>

    <!-- Modal for sending notification -->
    <div id="notification-modal" class="modal-overlay">
        <div class="modal-content">
            <button id="modal-close-btn" class="modal-close">&times;</button>
            <h3>×©×œ×™×—×ª ×”×ª×¨××” ×œ×œ×§×•×—</h3>
            <p><strong>××œ:</strong> <span id="modal-client-name"></span></p>
            <form id="notification-form">
                <input type="hidden" id="modal-client-id">
                 <div class="form-group">
                    <label for="notification-template">×‘×—×¨ ×ª×‘× ×™×ª ×”×•×“×¢×” (××•×¤×¦×™×•× ×œ×™)</label>
                    <select id="notification-template"></select>
                </div>
                <div class="form-group">
                    <label for="notification-title">×›×•×ª×¨×ª ×”×”×ª×¨××”</label>
                    <input type="text" id="notification-title" required>
                </div>
                <div class="form-group">
                    <label for="notification-body">×ª×•×›×Ÿ ×”×”×•×“×¢×”</label>
                    <textarea id="notification-body" rows="4" required></textarea>
                </div>
                <button type="submit" class="btn primary">×©×œ×— ×¢×›×©×™×•</button>
            </form>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- 1. CONFIGURATION & DOM ELEMENTS ---
        const API_URL = 'https://script.google.com/macros/s/AKfycbyXWrzRLGD9RyoVLjpjMcE0bQUS7BhEs9vgs_pmHwqRIfoRIYVq945LowncSwtJXj_o/exec';
        
        const dom = {
            onlineUsersList: document.getElementById('online-users-list'),
            onlineUsersLoader: document.getElementById('online-users-loader'),
            clientsTableBody: document.getElementById('clients-table-body'),
            requestsLog: document.getElementById('requests-log'),
            clientsLoader: document.getElementById('clients-loader'),
            requestsLoader: document.getElementById('requests-loader'),
            modal: document.getElementById('notification-modal'),
            modalCloseBtn: document.getElementById('modal-close-btn'),
            notificationForm: document.getElementById('notification-form'),
            modalClientId: document.getElementById('modal-client-id'),
            modalClientName: document.getElementById('modal-client-name'),
            templateSelect: document.getElementById('notification-template'),
            notificationTitleInput: document.getElementById('notification-title'),
            notificationBodyInput: document.getElementById('notification-body'),
        };

        const notificationTemplates = [
            { title: "×‘×—×¨ ×ª×‘× ×™×ª...", subject: "", text: "" },
            { title: "×¢×“×›×•×Ÿ ×œ×’×‘×™ ×”×–×× ×”", subject: "×¢×“×›×•×Ÿ ×œ×’×‘×™ ×”×–×× ×ª×š", text: "×©×œ×•× {{clientName}}, ×™×© ×œ× ×• ×¢×“×›×•×Ÿ ×‘× ×•×’×¢ ×œ×”×–×× ×ª×š." },
            { title: "× ×”×’ ×‘×“×¨×š", subject: "×”× ×”×’ ×‘×“×¨×š ××œ×™×š!", text: "×©×œ×•× {{clientName}}, ×”× ×”×’ ×‘×“×¨×š ××œ×™×š. ×¦×¤×™ ×”×’×¢×” ××©×•×¢×¨: {{eta}}" },
            { title: "×ª×–×›×•×¨×ª ×œ×¤×™× ×•×™", subject: "×ª×–×›×•×¨×ª ×œ×¤×™× ×•×™ ××›×•×œ×”", text: "×©×œ×•× {{clientName}}, ×ª×–×›×•×¨×ª ×§×˜× ×” ×©×”××›×•×œ×” ×¦×¤×•×™×” ×œ×”×ª×¤× ×•×ª ×‘×§×¨×•×‘." },
            { title: "×—×©×‘×•× ×™×ª ×—×“×©×”", subject: "×—×©×‘×•× ×™×ª ×—×“×©×” ×”×•×¤×§×” ×¢×‘×•×¨×š", text: "×©×œ×•× {{clientName}}, ×”×•×¤×§×” ×¢×‘×•×¨×š ×—×©×‘×•× ×™×ª ×—×“×©×” ×‘××¢×¨×›×ª." }
        ];

        // --- 2. CORE LOGIC ---
        
        /**
         * Fetches data from a specific API endpoint using GET, with robust error handling.
         * @param {string} action - The action to perform (e.g., 'getAllClients').
         */
        async function fetchData(action) {
            const url = `${API_URL}?action=${action}&cachebust=${new Date().getTime()}`;
            try {
                const response = await fetch(url);

                if (!response.ok) {
                    throw new Error(`×©×’×™××ª ×¨×©×ª (${response.status}) ×‘×¤×¢×•×œ×”: ${action}`);
                }
                
                // First, get the response as text to check if it's valid JSON
                const text = await response.text();
                
                try {
                    // Then, try to parse it
                    const data = JSON.parse(text);
                    if (data.error) {
                        throw new Error(`×©×’×™××ª ×©×¨×ª ×‘×¤×¢×•×œ×” ${action}: ${data.error}`);
                    }
                    return data;
                } catch (jsonError) {
                    // If parsing fails, it means the server returned something unexpected (like an HTML error page)
                    console.error("Failed to parse JSON from server. Response text:", text);
                    throw new Error("×”×ª×§×‘×œ×” ×ª×’×•×‘×” ×œ× ×ª×§×™× ×” ××”×©×¨×ª.");
                }

            } catch (fetchError) {
                // This catches network errors or the errors thrown above
                console.error(`Fetch operation failed for action "${action}":`, fetchError);
                throw fetchError; // Re-throw to be caught by the calling function
            }
        }


        /**
         * Fetches all dashboard data from the backend using multiple sequential calls.
         */
        async function loadDashboardData() {
            try {
                // Fetching data sequentially to avoid potential concurrency limits on the Google Apps Script server.
                const clientsData = await fetchData('getAllClients');
                const requestsData = await fetchData('getRecentRequests');
                
                // Process and render clients data
                if (clientsData && clientsData.clients) {
                    // NOTE: Using active clients for both sections for now.
                    const onlineUsers = clientsData.clients.map(c => ({...c, isOnline: true, lastSeen: '×¤×¢×™×œ ×›×¢×ª' }));
                    renderOnlineUsers(onlineUsers);
                    renderActiveClients(clientsData.clients);
                } else {
                    renderOnlineUsers([]);
                    renderActiveClients([]);
                }

                // Process and render requests data
                if (requestsData && requestsData.requests) {
                    renderRecentRequests(requestsData.requests);
                } else {
                    renderRecentRequests([]);
                }

            } catch (error) {
                console.error('Failed to load dashboard data:', error);
                alert(`×©×’×™××” ×§×¨×™×˜×™×ª ×‘×˜×¢×™× ×ª ×”× ×ª×•× ×™×: ${error.message}`);
                dom.onlineUsersLoader.textContent = '×˜×¢×™× ×ª ×”× ×ª×•× ×™× × ×›×©×œ×”';
                dom.clientsLoader.innerHTML = `<td colspan="5" class="placeholder-row">×˜×¢×™× ×ª ×”× ×ª×•× ×™× × ×›×©×œ×”</td>`;
                dom.requestsLoader.textContent = '×˜×¢×™× ×ª ×”× ×ª×•× ×™× × ×›×©×œ×”';
            }
        }


        // --- 3. UI RENDERING FUNCTIONS ---

        /**
         * Renders the list of "online" clients at the top.
         * @param {Array} clients - Array of all client objects.
         */
        function renderOnlineUsers(clients) {
            if (dom.onlineUsersLoader) dom.onlineUsersLoader.style.display = 'none';
            dom.onlineUsersList.innerHTML = '';

            if (clients.length === 0) {
                dom.onlineUsersList.innerHTML = '<li class="placeholder-item" style="width: 100%;">×œ× × ××¦××• ×œ×§×•×—×•×ª ×¤×¢×™×œ×™×.</li>';
                return;
            }

            clients.forEach(client => {
                const isOnline = client.isOnline;
                const lastSeenText = isOnline ? '××—×•×‘×¨/×ª ×›×¢×ª' : (client.lastSeen ? `× ×¨××” ×œ××—×¨×•× ×”: ${client.lastSeen}` : '×œ× ×™×“×•×¢');
                const statusText = isOnline ? '××—×•×‘×¨' : '×œ× ××—×•×‘×¨';

                const userElement = document.createElement('li');
                userElement.className = 'online-user';
                userElement.innerHTML = `
                    <div class="avatar-container">
                        <img src="https://ui-avatars.com/api/?name=${encodeURIComponent(client.clientName)}&background=0b72b9&color=fff&size=128" alt="${client.clientName}" class="avatar">
                        <span class="status-dot ${isOnline ? 'online' : 'offline'}"></span>
                        <div class="user-tooltip">
                            <p><strong>×¡×˜×˜×•×¡:</strong> 
                               <span class="tooltip-status-indicator" style="background-color: ${isOnline ? 'var(--success)' : 'var(--secondary)'};"></span>
                               ${statusText}
                            </p>
                            <p>${lastSeenText}</p>
                        </div>
                    </div>
                    <div class="user-info">
                        <span class="user-name">${client.clientName}</span>
                        <span class="user-id">#${client.clientId}</span>
                    </div>`;
                dom.onlineUsersList.appendChild(userElement);
            });
        }
        
        /**
         * Renders the table of clients with active containers.
         * @param {Array} clients - Array of active client objects.
         */
        function renderActiveClients(clients) {
            if (dom.clientsLoader) dom.clientsLoader.style.display = 'none';
            dom.clientsTableBody.innerHTML = '';
            if (clients.length === 0) {
                dom.clientsTableBody.innerHTML = '<tr><td colspan="5" class="placeholder-row">×œ× × ××¦××• ×œ×§×•×—×•×ª ×¢× ××›×•×œ×•×ª ×¤×¢×™×œ×•×ª.</td></tr>';
                return;
            }

            clients.forEach(client => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${client.clientId}</td>
                    <td>${client.clientName}</td>
                    <td>${client.address}</td>
                    <td>${client.daysOnSite}</td>
                    <td>
                        <button class="btn primary notification-btn" data-id="${client.clientId}" data-name="${client.clientName}">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 16a2 2 0 0 0 2-2H6a2 2 0 0 0 2 2zM8 1.918l-.797.161A4.002 4.002 0 0 0 4 6c0 .628-.134 2.197-.459 3.742-.16.767-.376 1.566-.663 2.258h10.244c-.287-.692-.502-1.49-.663-2.258C12.134 8.197 12 6.628 12 6a4.002 4.002 0 0 0-3.203-3.92L8 1.917zM14.22 12c.223.447.481.801.78 1H1c.299-.199.557-.553.78-1C2.68 10.2 3 6.88 3 6c0-2.42 1.72-4.44 4.005-4.901a1 1 0 1 1 1.99 0A5.002 5.002 0 0 1 13 6c0 .88.32 4.2 1.22 6z"/></svg>
                            ×©×œ×— ×”×ª×¨××”
                        </button>
                    </td>`;
                dom.clientsTableBody.appendChild(row);
            });
        }

        /**
         * Renders the log of recent client requests.
         * @param {Array} requests - Array of request objects.
         */
        function renderRecentRequests(requests) {
            if (dom.requestsLoader) dom.requestsLoader.style.display = 'none';
            dom.requestsLog.innerHTML = '';
            if (requests.length === 0) {
                dom.requestsLog.innerHTML = '<li class="placeholder-item">××™×Ÿ ×‘×§×©×•×ª ×—×“×©×•×ª.</li>';
                return;
            }

            requests.forEach(req => {
                const item = document.createElement('li');
                const requestTypeClean = req.type.split(" ")[0];
                const iconMap = {
                    '×”×—×œ×¤×”': 'ğŸ”„', '×”×¢×œ××”': 'ğŸ”¼', '×”×•×¨×“×”': 'ğŸ”½', '×”×•×“×¢×ª': 'ğŸ’¬', '×¤×™× ×•×™': 'ğŸ”¼'
                };
                item.innerHTML = `
                    <div class="icon ${requestTypeClean}">
                        ${iconMap[requestTypeClean] || 'â”'}
                    </div>
                    <div class="content">
                        <strong>×‘×§×©×ª ${req.type}</strong>
                        <span>${req.details || ''}</span>
                        <div class="meta">${req.clientName} â€¢ ${new Date(req.timestamp).toLocaleString('he-IL')}</div>
                    </div>`;
                dom.requestsLog.appendChild(item);
            });
        }

        // --- 4. MODAL & NOTIFICATION LOGIC ---
        
        function openNotificationModal(clientId, clientName) {
            dom.modalClientId.value = clientId;
            dom.modalClientName.textContent = clientName;
            
            dom.templateSelect.innerHTML = '';
            notificationTemplates.forEach((t, i) => {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = t.title;
                dom.templateSelect.appendChild(option);
            });

            dom.notificationForm.reset();
            dom.modal.classList.add('show');
        }

        function fillTemplate() {
            const selectedIndex = dom.templateSelect.value;
            const template = notificationTemplates[selectedIndex];
            if (!template || selectedIndex == 0) return;

            const clientName = dom.modalClientName.textContent;
            let body = template.text.replace('{{clientName}}', clientName);
            
            dom.notificationTitleInput.value = template.subject;
            dom.notificationBodyInput.value = body;
        }

        async function handleSendNotification(event) {
            event.preventDefault();
            const clientId = dom.modalClientId.value;
            const title = dom.notificationTitleInput.value;
            const body = dom.notificationBodyInput.value;
            
            const submitBtn = dom.notificationForm.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = '×©×•×œ×—...';
            submitBtn.disabled = true;

            try {
                const result = await postData('sendAdminNotification', { clientId, title, body });
                if (result) {
                    alert('×”×”×ª×¨××” × ×©×œ×—×” ×‘×”×¦×œ×—×”!');
                    dom.modal.classList.remove('show');
                }
            } finally {
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        }

        async function postData(action, payload) {
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify({ action, ...payload })
                });
                if (!response.ok) throw new Error(`Network error: ${response.statusText}`);
                const result = await response.json();
                if (result.status !== 'success' && result.status !== 'ok' ) throw new Error(result.message || 'Unknown API error');
                return result;
            } catch (error) {
                console.error(`Failed to post ${action}:`, error);
                alert(`×©×œ×™×—×ª ×”× ×ª×•× ×™× × ×›×©×œ×”: ${error.message}`);
                return null;
            }
        }

        // --- 5. EVENT LISTENERS ---

        function initializeEventListeners() {
            // Event delegation for dynamically added notification buttons
            dom.clientsTableBody.addEventListener('click', (event) => {
                const button = event.target.closest('.notification-btn');
                if (button && button.dataset.id) {
                    openNotificationModal(button.dataset.id, button.dataset.name);
                }
            });

            // Modal listeners
            dom.modalCloseBtn.addEventListener('click', () => dom.modal.classList.remove('show'));
            dom.notificationForm.addEventListener('submit', handleSendNotification);
            dom.templateSelect.addEventListener('change', fillTemplate);
            
            // Auto-refresh data every 45 seconds
            setInterval(loadDashboardData, 45000);
        }

        // --- 6. APP START ---
        loadDashboardData();
        initializeEventListeners();
    });
    </script>
</body>
</html>

