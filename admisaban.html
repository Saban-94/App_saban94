<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ניהול בקשות - ח.סבן</title>
    <link rel="icon" href="https://i.postimg.cc/2SbDgD1B/1.png">
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --brand: #0b72b9; --accent: #ff9f1c; --bg: #f0f2f5; --card: #ffffff;
            --text-dark: #1a202c; --text-light: #4a5568; --text-muted: #718096;
            --border: #e2e8f0; --success: #38a169; --danger: #e53e3e;
            --radius: 12px; --shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
        }
        body {
            font-family: 'Assistant', sans-serif;
            background-color: var(--bg);
            margin: 0;
            padding: 20px;
        }
        #app-container { max-width: 1200px; margin: 0 auto; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .header h1 { margin: 0; }
        .loader { text-align: center; padding-top: 50px; font-size: 1.2rem; }
        .card { background: var(--card); border-radius: var(--radius); box-shadow: var(--shadow); margin-bottom: 15px; padding: 20px; }
        .request-header { display: flex; justify-content: space-between; align-items: flex-start; }
        .request-header h3 { margin: 0 0 5px 0; }
        .request-meta { color: var(--text-muted); font-size: 0.9rem; }
        .request-details { margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border); }
        .status-badge { padding: 5px 12px; border-radius: 20px; font-weight: 600; cursor: pointer; transition: background-color 0.2s; }
        .status-badge.new { background-color: #fed7d7; color: #c53030; }
        .status-badge.done { background-color: #c6f6d5; color: #2f855a; }
        .action-button { background: none; border: 1px solid var(--brand); color: var(--brand); padding: 8px 16px; border-radius: 8px; cursor: pointer; margin-right: 10px; }
    </style>
</head>
<body>
    <div id="app-container">
        <div class="header">
            <h1>לוח בקשות בזמן אמת</h1>
            <div id="connection-status">מתחבר...</div>
        </div>
        <div id="requests-list" class="loader">טוען בקשות...</div>
    </div>

    <script>
        (function() {
            const dom = {
                requestsList: document.getElementById('requests-list'),
                connectionStatus: document.getElementById('connection-status'),
            };

            const state = {
                requests: [],
            };

            // --- API Communication ---
            function api(action, payload) {
                return new Promise((resolve, reject) => {
                    google.script.run
                        .withSuccessHandler(resolve)
                        .withFailureHandler(reject)
                        .doPost({ action, ...payload });
                });
            }

            // --- Firebase Setup ---
            function initializeFirebase() {
                const firebaseConfig = {
                   apiKey: "AIzaSyDy3k1AoEKeuCKjmFxefn9fapeqv2Le1_w",
                   authDomain: "hsaban94-cc777.firebaseapp.com",
                   databaseURL: "https://hsaban94-cc777.firebaseio.com",
                   projectId: "hsaban94-cc777",
                   storageBucket: "hsaban94-cc777.firebasestorage.app",
                   messagingSenderId: "299206369469",
                   appId: "1:299206369469:web:6e8674eb787e52fa9457d4"
                };
                firebase.initializeApp(firebaseConfig);
                const db = firebase.firestore();
                listenToNewRequests(db);
            }

            function listenToNewRequests(db) {
                dom.requestsList.classList.remove('loader');
                dom.connectionStatus.textContent = 'מחובר';
                dom.connectionStatus.style.color = 'var(--success)';

                db.collection("requests").orderBy("Timestamp", "desc").onSnapshot(snapshot => {
                    console.log("Real-time update received from Firestore.");
                    const newRequests = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    state.requests = newRequests;
                    render();
                }, error => {
                    console.error("Firestore snapshot error:", error);
                    dom.connectionStatus.textContent = 'שגיאת חיבור';
                    dom.connectionStatus.style.color = 'var(--danger)';
                });
            }

            // --- Rendering ---
            function render() {
                if (state.requests.length === 0) {
                    dom.requestsList.innerHTML = '<div class="card"><p>אין בקשות חדשות כרגע.</p></div>';
                    return;
                }
                dom.requestsList.innerHTML = state.requests.map(req => renderRequestCard(req)).join('');
            }

            function renderRequestCard(req) {
                const isNew = req['סטטוס טיפול'] === 'חדש';
                const statusClass = isNew ? 'new' : 'done';
                const statusText = isNew ? 'חדש' : 'בוצע';
                
                return `
                    <div class="card" data-id="${req.id}" data-client-id="${req['מספר לקוח']}">
                        <div class="request-header">
                            <div>
                                <h3>${req['סוג הבקשה']}</h3>
                                <div class="request-meta">
                                    <strong>${req['שם לקוח']}</strong> (${req['מספר לקוח']}) - 
                                    <span>${new Date(req.id).toLocaleString('he-IL')}</span>
                                </div>
                            </div>
                            <div class="status-badge ${statusClass}" data-action="toggle-status">${statusText}</div>
                        </div>
                        <div class="request-details">
                            <p>${req['פרטים']}</p>
                            <button class="action-button" data-action="send-notification">שלח התראה</button>
                        </div>
                    </div>
                `;
            }

            // --- Event Handlers ---
            async function handleToggleStatus(e) {
                const card = e.target.closest('.card');
                const requestId = card.dataset.id;
                const currentStatus = e.target.textContent;
                const newStatus = currentStatus === 'חדש' ? 'בוצע' : 'חדש';
                
                e.target.textContent = 'מעדכן...';
                try {
                    await api('updateRequestStatus', { requestId, status: newStatus });
                    // Firestore listener will handle the re-render automatically
                } catch (error) {
                    console.error("Failed to update status:", error);
                    e.target.textContent = currentStatus; // Revert on error
                }
            }

            function handleSendNotification(e) {
                const card = e.target.closest('.card');
                const clientId = card.dataset.clientId;
                const clientName = card.querySelector('strong').textContent;
                
                const message = prompt(`הקלד הודעה קצרה לשליחה אל ${clientName}:`, "הטיפול בבקשתך הושלם.");
                if (message) {
                    api('sendNotificationToClient', { clientId, title: 'עדכון מ-ח.סבן', message })
                        .then(res => alert('ההתראה נשלחה בהצלחה!'))
                        .catch(err => alert('שגיאה בשליחת התראה: ' + err));
                }
            }
            
            // --- Initialization ---
            function init() {
                initializeFirebase();
                
                dom.requestsList.addEventListener('click', e => {
                    const action = e.target.dataset.action;
                    if (action === 'toggle-status') handleToggleStatus(e);
                    if (action === 'send-notification') handleSendNotification(e);
                });
            }

            document.addEventListener('DOMContentLoaded', init);
        })();
    </script>
</body>
</html>

